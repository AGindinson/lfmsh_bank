---
title: "Анализ данных экономической игры ЛФМШ-30"
author: "Никита Коробков | nikkorobk@gmail.com"
email: nikkorobk@gmail.com
date: "9/20/2017"
output:
  html_document:
    toc: yes
    toc_depth: 4
  pdf_document:
    keep_tex: yes
    toc: yes
    toc_depth: 4
header-includes:
urlcolor: blue
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(psych)


Sys.setlocale("LC_CTYPE", "ru_RU")

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width=9)
```

```{r data_load, include=FALSE, cache=TRUE}
students = as_data_frame(read.csv('../data/student_features.csv'))
time = as_data_frame(read.csv('../data/time_features.csv'))
type = as_data_frame(read.csv('../data/type_features.csv'))
money = read.csv('../data/money.csv',sep=',', stringsAsFactors=FALSE, encoding = "UTF-8")
counters = read.csv('../data/counters.csv',sep=',', stringsAsFactors=FALSE, encoding = "UTF-8")

```
## Вступление
В августе 2017 года прошла 30 смена [Летней Физико-Математической Школы](http://lfmsh.ru/). 
В рамках смены традиционно проводилась экономическая игра. В ходе игры слушателям школы за положительную активность начислялась виртуальная валюта, которую в конце смены можно было потратить на разные полезные штуковины.  
В результате собралось внушительное количество данных о всех перемещениях виртуальных баксов в лагере. Эти данные мы и попробуем осмыслить.

## Знакомство с Пионерами
### Анализ суммарного заработка пионеров

```{r earnings_list}
earnings_list = as.data.frame(students["Заработано.за.смену"])[,1]
```

Всего в лагерь приехало `r length(students$username)` пионеров закончивших классы с `r min(students$grade)` по `r max(students$grade)`. Для каждого пионера известно сколько виртуальных денег он заработал в течении смены. Всего дети заработали **`r format(round(sum(earnings_list)))`\@** . В среднем на человека пришлось по **`r round(mean(earnings_list))`\@**, самый богатый пионер накопил **`r round(max(earnings_list))`\@**, а самый бедный только **`r round(min(earnings_list))`\@**.  


Посмотрим на гистограмму отражающую заработок населения. 

```{r all_students_hist}
ggplot(students, aes(x = `Заработано.за.смену`)) + 
  geom_histogram(bins = 40, fill='#56B4E9', col = '#0072B2', alpha=0.3) +
  geom_vline(xintercept = mean(earnings_list), col='#E69F00') +
  scale_x_continuous('Заработок за смену',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_y_continuous('Количество пионеров', breaks = seq(0, 10, 1))
sel = shapiro.test(earnings_list[earnings_list < 1100])
```

Не смотря на то что на вид распределение заработка по пионерам слабо отличается он нормального, считать его нормальным мы не можем из за трех значений в самой правой части графика. Эти значения слишком сильно отклоняются от среднего чтобы принять гипотезу о нормальности распределения. Зато если их выкинуть, то оставшиеся значения будут распределены вполне себе нормально (Значение p-value для теста Шапиро-Уилка = `r sel$p.value`).    

На время уберем трех самых богатых пионеров из выборки и построим такие же гистограммы разделив пионеров на группы по калассам.  
Нормальность распределения внутри группы сохраняется. Значения p-value для теста Шапиро-Уилка по классам приведены в таблице. 

```{r shapiro_by_grade}
d = function(earnings) shapiro.test(earnings)$p.value

by_grade = students %>%
  filter(grade < 11, `Заработано.за.смену` < 1100)%>%
  mutate(grade = factor(grade)) %>%
  group_by(grade) %>%
  mutate(mean_in_grade = mean(`Заработано.за.смену`), min_in_grade = as.numeric(mean_cl_boot(`Заработано.за.смену`)['ymin']), max_in_grade = as.numeric(mean_cl_boot(`Заработано.за.смену`)['ymax']))

s2 = by_grade %>%
  group_by(grade) %>%
  summarise( Shapiro_test_p_value = d(`Заработано.за.смену`))
s22 = t(s2$Shapiro_test_p_value)
colnames(s22) = s2$grade
a2 = data.frame(Класс = c('p-value'))
s22 = cbind(a2,s22)

knitr::kable(s22, caption = 'Значеня p-value для теста Шапиро-Вилка при делении на группы по классу')

```

На гистограммах оранжевым отмечено среднее значение заработка по всей выборке, а красным -- внутри гурппы. Красным пунктиром выделены доверительные интервалы среднего значения. Так как из 11 класса приехало всего два человека, их рассматривать не будем.


```{r by_grade_plot}


ggplot(by_grade, aes(x = `Заработано.за.смену`,group=grade)) + 
  geom_histogram(bins=30, fill='#56B4E9', col = '#0072B2', alpha=0.3) +
  geom_vline(aes(xintercept = mean(earnings_list[earnings_list<1100])),  col='#E69F00') +
  facet_grid(grade~.)  + 
  geom_vline(aes(xintercept = mean_in_grade, group = grade),  col='#D55E00') +
  geom_vline(aes(xintercept = min_in_grade,  group = grade),linetype="dashed",  col='#D55E00') +
  geom_vline(aes(xintercept = max_in_grade, group = grade),linetype="dashed",  col='#D55E00') + 
  scale_x_continuous('Заработок за смену',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_y_continuous('Количество пионеров', breaks = seq(0, 10, 1))
```

Из графиков видно что средний заработок 10 класса значимо отличается от среднего заработка 8 и 9 классов.

### Составляющие успеха

Для каждого из слушателей собрана статистика не только о суммарном заработке за смену, но и о заработке в отдельных категориях, таких как например "Учебная деятельность" или "Участие в мероприятиях" и даже "Посещение заряки" и "Чистка картошки". Посмотрим как могут быть связаны между собой эти показатели.  
Всего для каждого из пионеров собрано более 70 различных значений. Разумеется большинство пар измерений никак не связаны между собой и рассмотривать их нет смысла. 
Выберем несколько интересующих нас областей и попробуем найти взаимосвязи внутри них.

1. Связь не денежных показателей с сумарным заработком и заработком в связанных категориях. 
2. Связь разных направлений учебной деятельности. 
3. Связь факта покупки книги с категориями заработка
4. Связь заработка за спорт с заработком за учебу


#### Связь не денежных показателей с сумарным заработком

Всего у нас 11 не связанных напрямую с деньгами показателей. Это счетчики посещений лекций, лабораторий, факультативов, зарядок и семинаров. Счетчкики пропусков и сертификаты на книжки.  
Большинство этих величин так или иначе косвенно связаны с заработком. Так например посещение лаборатории всегда означает денежное вознаграждение за сдачу отчета и тому подобное.  
Есть только два действительно не связанных на прямую с деньгами показателя. Это **посещения семинаров** и **посещения зарядки**. За посещение семинаров слушатели не получают денег совсем, а за зарядку хоть и платят, но на столько мало, что существенного вклада в общую картину эта сумма внести не может. 

##### Связь количества посещенных семинаров с сумарным заработком

Отложим на графике по X количество посещенных семинаров, а по Y все ту же сумму заработанных за смену денег. 

```{r sem_no_smooth}
ggplot(students, aes(x = `Счетчик.Посещение.семинара`, y = `Заработано.за.смену`))+
  geom_point() + 
  scale_y_continuous('Заработок за смену',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_x_continuous('Количество посещенных семинаров', breaks = seq(0, 20, 1)) + 
  theme_minimal()
```

Можно заметить небольшой ниcходящий тренд. Но может быть нам только кажется ?
Давайте построим линейную модель. 

```{r sem_model}
fit = lm(earn~Количество_посещенных_семинаров, data=select(students,earn = `Заработано.за.смену`, Количество_посещенных_семинаров = `Счетчик.Посещение.семинара` ))
sf = summary(fit)

knitr::kable (sf["coefficients"], caption = 'Параметры линейной модели зависимости заработка за смену от количества посещенных семинаров')
```

Действительно, видим что p-value для количества семинаров < 0.05 а значит можно утверждать что посещение семинаров влияет на сумарный заработок. Как видно из коэфицентов модели, каждый посещенный семинар в среднем на **8\@** уменьшает заработок пионера.  
Это и не удивительно. За семинары не платят денег, а вместо того чтобы слушать семинары можно пойти на факультатив или сделать лабу. В среднем за факультатив на протяжении смены получали по **`r round( mean(as.data.frame(students['Зачет.по.факультативу'])[,1]/as.data.frame(students['Счетчик.Посещение.факультатива'])[,1], na.rm = TRUE), 2)`\@** что как раз попадает в доверительные интервалы коэфицента при семинарах в линейной модели (- 8.5 +- 3.5)

Еще более явно эту взаимосвязь можно увидеть если построить зависимость заработанных за учебу денег от количества посещенных семинаров. Построим такой график, а заодно отобразим на нем линию тренда предсказанную линейной моделью.


```{r sem_with_lm}

ggplot(students, aes(x = `Счетчик.Посещение.семинара`, y = `Общие.Учеба`, col = `Заработано.за.смену`))+  
  geom_point() +
  scale_colour_gradientn(colours=topo.colors(3)) +
  geom_smooth(method = 'lm', se = FALSE) + 
  scale_y_continuous('Заработок за Учебу',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_x_continuous('Количество посещенных семинаров', breaks = seq(0, 20, 1)) + 
  theme_minimal()

  
fit = lm(earn~Количество_посещенных_семинаров, data=select(students,earn = `Общие.Учеба`, Количество_посещенных_семинаров = `Счетчик.Посещение.семинара` ))
ps = summary(fit)$coefficients[2,4] 
ks = summary(fit)$coefficients[2,1] 

```

Видим что 
1. Заработок за учебу сильно корелирует с заработком за смену, что не удивительно. 
2. Заработок за учебу еще сильнее подвержен влиянию количества посещенных семинаров. В этой модели каждый посещенный семинар уменьшает ожидаемый заработок за учебу уже на целых **`r round(ks, 2)`\@**. 


##### Связь количества посещенных зарядок с сумарным заработком

Для начала проверим, ходил ли кто-нибудь вообще на зарядку в этой смене. 

```{r workout_hist}
ggplot(students, aes(x = `Счетчик.Зарядка`)) + 
  geom_histogram(bins = 15, fill='#56B4E9', col = '#0072B2', alpha=0.3) +
  scale_x_continuous('Посещения зарядки',seq(0, 14, 1)) + 
  scale_y_continuous('Количество пионеров', breaks = seq(0, 70, 5))+ 
  theme_minimal()
```

Больше половины пионеров на зарядке не появились ни разу. Зато из тех кто продержался и не бросил после первых двух раз больше половины доходили до самого конца (>10).  
Построим ящики с усами чтобы проверить есть ли какие-нибудь значимые различия между мощными парнями и девчонками сходившими три и более раз на зарядку и остальным лагерем. 

```{r workout boxplot}
students = mutate(students, hard_workout = as.factor(`Счетчик.Зарядка`>=3))
ggplot(students, aes(x =hard_workout, y = `Заработано.за.смену`))+  
  geom_boxplot(fill='#56B4E9', alpha=0.3) + 
  scale_x_discrete("Посещения зарядки", labels = c("TRUE" = ">= 3", "FALSE" = "<3")) + 
  theme_minimal()

  
fit = aov(`Заработано.за.смену`~hard_workout, students)
ps_earn = summary(fit)[[1]][[5]][1]

  
fit = aov(`Общие.Спорт`~hard_workout, students)
ps_sport = summary(fit)[[1]][[5]][1]
```

К сожалению явных различий не видно. Коэфиценты дисперсионного анализа подтверждают отстутствие взаимосвязи. При сравнении заработка p-value = `r ps_earn`, а при сравнении заработка только за спорт p-value = `r ps_sport`.  

#### Связь разных направлений учебной деятельности

В лагере множество способов получить новые знания. Как мы уже выяснили посещение большого количества семинаров отрицательно влияет на общий заработок за учебу, а как на счет остальных областей? И есть ли связь между различными областями?

Деньги за учебу начислялись в семи категориях. Для того чтобы выяснить какие из этиъ категорий действительно связаны между собой посмотрим на значения p-value для коэфицентов кореляции Пирса между всеми парами.  
_Нулевая гипотеза здесь говорит о том что коэфицент кореляции = 0_

```{r study_cor_p}


cor_res = corr.test(select(students, Кружки = `Зачет.по.кружку`, Факультативы = `Зачет.по.факультативу`, Лабы =  `Лабораторная.работа`,Олимпиады = `Олимпиада`,Проведение_семинара = `Проведение.семинара`,Решение_убойных_задач  = `Решение.убойных.задач`,`Экзамен`))

knitr::kable(cor_res$p, caption = "Значения p-value")
```

Видим что почти все переменные, за исключением разве что Кружков и Семинаров, значимо корелируют между собой. Отбросим не интересные слабо корелирующие показатели и выведем значения самого коэфицента кореляции для оставшихся пар.


```{r study_cor_r}
study_info= select(students, Факультативы = `Зачет.по.факультативу`, Лабы =  `Лабораторная.работа`,Олимпиады = `Олимпиада`,Решение_убойных_задач  = `Решение.убойных.задач`,`Экзамен`)
cor_res2 = corr.test(study_info)
knitr::kable(cor_res2$r, caption = "Коэфицент кореляции Пирса для доходов за учебу")
```

Все кореляции положительные. Что не удивительно. Те кто много ботают ботают везде. 
Построим пару графиков чтобы проилюстрировать этот незатейливый факт. 

```{r study_graphs}
  
ggplot(study_info, aes(x = Факультативы, y = Олимпиады, size = Решение_убойных_задач)) + 
  geom_point(fill='#56B4E9', alpha=0.6, col = '#0072B2') + 
  theme_minimal()
```

_Успех в олимпиадах и убойках от суммы за факультативы_


```{r study_graphs_2}

ggplot(study_info, aes(x = Экзамен, y = Лабы)) + 
  geom_point(fill='#56B4E9', alpha=0.9 , col = '#b24000' ) + 
  geom_smooth(method = 'lm', formula = y~splines::bs(x, 3), se = FALSE) + 
  theme_minimal()


```

_Хорошо пишущие экзамен ребята часто выполняют больше лаб чем необходимо._


#### Связь факта покупки книги с категориями заработка

Существует как минимум три основных пути потратить деньги в лагере. 
1. Купить книжку
2. Заказать что-то из магазина в городе
3. Купить лот на аукционе

Посмотрим, определяет ли то откуда деньги появились то на что они будут потрачены. 

```{r}


spendings_info= select(students, Книжки = `Покупка.книг`, Магазин =  `Покупка.товаров`,Аукцион = `Покупка.на.аукционе`,Услуги  = `Покупка.услуг`,starts_with("Общие")) %>%
  mutate(Купил_книжку = factor(Книжки<0))

ggplot(spendings_info, aes(x = Общие.Мероприятие, y = Общие.Спорт, col=Купил_книжку)) + 
  geom_point(fill='#56B4E9', alpha=0.9) + 
    scale_y_continuous('Заработок за Спорт',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_x_continuous('Заработок за Мероприятия',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 

  theme_minimal()
```
```{r plots_for_spendings2, fig.width=3.5, fig.height=3}

ggplot(spendings_info, aes(x = Общие.Мероприятие,  col=Купил_книжку)) + 
  geom_density(alpha=0.9) + 
    guides(col=FALSE) + 
    scale_x_continuous('Заработок за Мероприятия',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
    scale_y_continuous('Плотность') + 
  theme_minimal()


ggplot(spendings_info, aes(x = Общие.Спорт,  col=Купил_книжку)) + 
  geom_density(alpha=0.9) + 
      guides(col=FALSE) + 
  scale_x_continuous('Заработок за Спорт',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_y_continuous('Плотность') + 
  theme_minimal()
```

Сложно сказать что-то определенное. Оставим выводы на на усмотрение читателя.  
Покупайте книжки. Особенно если заработали кучу баксов на соревнованиях по армреслингу. 


#### Связь заработка за спорт с заработком за учебу

Да, здесь просиходит именно то что вы думаете. Чем больше пионер заработал на спорте, тем меньше он получил за учебу. В среднем один спортивный бакс = -2 учебным. И зарядка тут не при чем. 


```{r  stud_sport, fig.width=9}
fit = lm(`Общие.Учеба`~Заработок_за_спорт, students %>% mutate(Заработок_за_спорт = `Общие.Спорт`))
sf = summary(fit)$coefficients
knitr::kable(sf, caption = "Коэфиценты линейной модели предсказания заработка за учебу по заработку за спорт")

ggplot(students, aes(x = Общие.Учеба, y = Общие.Спорт)) + 
  geom_point(fill='#56B4E9', alpha=0.9, aes( color=hard_workout)) + 
  geom_smooth(method = 'lm')+
  scale_color_discrete(name = "Посещения Зарядки", labels=c("FALSE" ="<3","TRUE"=">=3")) + 
  scale_y_continuous('Заработок за Спорт',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_x_continuous('Заработок за Учебу',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) 
kmeans
  
```


### Стратификация общества

В заключение главы про слушателей ЛФМШ, давайте попробуем разделить всех на ~~психотипы~~ группы по каким-нибудь показателям. Благо показателей у нас много. 




```{r}

cor_res1 = corr.test(select(students, Проведение_семинара = `Проведение.семинара`,`Общие.Спорт`))



money %>% filter(type_group_general == "Учеба") %>%
  group_by(type_readable_name) %>%
  summarise(count = n())


hist(students$`Счетчик.Зарядка`)

sum(students$`Счетчик.Зарядка` > 2)
sum(students$`Счетчик.Зарядка` > 10)
sum(students$`Счетчик.Зарядка` == 1)

ggplot(students, aes(x = as.factor(`Счетчик.Зарядка`>3), y = `Заработано.за.смену`))+  
  geom_boxplot() 
  
  

fit = lm(`Общие.Спорт`~`Счетчик.Зарядка`, students)
summary(fit)


standartize = function (x)  (x-mean(x))/var(x)

inter = select(students, starts_with("Общие"),  -`Общие.Технические.Типы`,-`Общие.Другое`, -`Общие.Переводы`, `Заработано.за.смену`)
all_num = select(students,-receiver_username,-username, -first_name, -last_name, -hard_workout )

all_cor = corr.test(select(all_num,`Заработано.за.смену`), select(all_num, -`Заработано.за.смену`))

f = all_cor$p
f[1,33]
all_cor[1]
sum(all_cor$p< 0.05 & all_cor$r< 0, na.rm = TRUE)

ff = all_cor$p  < 0.05 & all_cor$r  < 0 

rr <- colnames(ff)[col(ff)[which(ff)]]

corr.test(select(all_num,`Заработано.за.смену`), select(all_num, `Счетчик.Посещение.семинара`))$r

sum(all_cor$p  < 0.05 & all_cor$r  < 0  )
pairs(sapply(inter, standartize))




```

